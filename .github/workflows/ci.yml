name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  build:
    name: build
    runs-on: ubuntu-latest
    env:
      IRON_SESSION_PASSWORD: ${{ secrets.IRON_SESSION_PASSWORD }}
      NEXT_PUBLIC_APP_BASE_URL: ${{ secrets.NEXT_PUBLIC_APP_BASE_URL }}
      NEXT_PUBLIC_DASHBOARD_BASE_URL: ${{ secrets.NEXT_PUBLIC_DASHBOARD_BASE_URL }}
      DASHBOARD_SIGNING_SECRET: ${{ secrets.DASHBOARD_SIGNING_SECRET }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      CLERIO_LOGIN_URL: ${{ secrets.CLERIO_LOGIN_URL }}
      NEXT_PUBLIC_LOGIN_URL: ${{ secrets.NEXT_PUBLIC_LOGIN_URL }}
      GMAIL_OAUTH_STATE_SECRET: ${{ secrets.GMAIL_OAUTH_STATE_SECRET }}
      DRIVE_OAUTH_STATE_SECRET: ${{ secrets.DRIVE_OAUTH_STATE_SECRET }}
      OUTLOOK_OAUTH_STATE_SECRET: ${{ secrets.OUTLOOK_OAUTH_STATE_SECRET }}
      OUTLOOK_CLIENT_ID: ${{ secrets.OUTLOOK_CLIENT_ID }}
      OUTLOOK_CLIENT_SECRET: ${{ secrets.OUTLOOK_CLIENT_SECRET }}
      ONEDRIVE_OAUTH_STATE_SECRET: ${{ secrets.ONEDRIVE_OAUTH_STATE_SECRET }}
      ONEDRIVE_CLIENT_ID: ${{ secrets.ONEDRIVE_CLIENT_ID }}
      ONEDRIVE_CLIENT_SECRET: ${{ secrets.ONEDRIVE_CLIENT_SECRET }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run build

  test:
    name: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm test --if-present
